name: Package PR

on:
  workflow_call:
    inputs:
      goVersion:
        description: "Go version"
        required: true
        type: number
      packagePath:
        description: "Package path"
        required: true
        type: string
      branch:
        description: "Branch to checkout"
        required: true
        type: string

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.goVersion }}

      - name: Build
        env:
          PKG: ${{ inputs.packagePath }}
        run: go build -mod=readonly -v ./${{ inputs.packagePath }}

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        id: setup-up-go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.goVersion }}

      - name: Install gotestfmt
        run: go install github.com/gotesttools/gotestfmt/v2/cmd/gotestfmt@latest

      - name: Test pretty
        id: test-pretty
        env:
          PKG: ${{ inputs.packagePath }}
          CACHE: true
        run: ./src/sh/workflows/package-pr/test-pretty.sh

      - name: Annotate
        if: always()
        uses: guyarb/golang-test-annotations@v0.8.0
        with:
          test-results: ${{ steps.test-pretty.outputs.testOutputJson }}
          package-name: github.com/tcodes0/go

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        id: setup-up-go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.goVersion }}

      - name: Lint
        uses: golangci/golangci-lint-action@v5.1.0
        with:
          version: latest
          working-directory: ${{ inputs.packagePath }}
          skip-cache: false
          args: --print-issued-lines=false
